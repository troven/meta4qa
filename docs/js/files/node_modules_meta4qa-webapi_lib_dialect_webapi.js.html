<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules/meta4qa-webapi/lib/dialect/webapi.js - meta4qa</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/img/logo.png" title="meta4qa" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>Dialect Definitions for: 1.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Phrases</a></li>
                            <li><a href="#api-modules">Dialects</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Builder.html">Builder</a></li>
                                <li><a href="../classes/Common.html">Common</a></li>
                                <li><a href="../classes/Events.html">Events</a></li>
                                <li><a href="../classes/File System.html">File System</a></li>
                                <li><a href="../classes/TCP Toolkit.html">TCP Toolkit</a></li>
                                <li><a href="../classes/Transform.html">Transform</a></li>
                                <li><a href="../classes/Variables.html">Variables</a></li>
                                <li><a href="../classes/Web API.html">Web API</a></li>
                                <li><a href="../classes/X.509 Server Certificates.html">X.509 Server Certificates</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Default Dialect.html">Default Dialect</a></li>
                                <li><a href="../modules/Web API Dialect.html">Web API Dialect</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: node_modules/meta4qa-webapi/lib/dialect/webapi.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var assert = require(&#x27;assert&#x27;);
var request = require(&#x27;request&#x27;);
var _ = require(&#x27;lodash&#x27;);
var fs = require(&#x27;fs&#x27;);
var path = require(&#x27;path&#x27;);
var debug = require(&#x27;debug&#x27;)(&quot;dialect:webapi&quot;);
var meta4qa = require(&#x27;meta4qa&#x27;),
	helps = meta4qa.helpers,
	files = helps.files,
	http = helps.http;
var speakeasy = require(&quot;speakeasy&quot;);
var webapi = helps.webapi = require(&quot;../helpers/webapi&quot;);

/**
 * Web API
 * Configures the Yadda parser with phrases that support operations on HTTP APIs
 *
 * @module Web API Dialect
 * @class Web API
 *
 */

var WebAPI = module.exports = function (learn, config) {

	var VERBOSE = false;

	// ******** GIVEN ********


	/**
	 * Add a client certificate to an HTTP request.
	 * The certificate itself is defined in the config.json file.
	 *
	 *      I use a $CERT client certificate
	 *
	 *      I use an $CERT client certificate
	 *
	 * @example
	 *
	 *      I use a valid client certificate
	 *
	 * @method Use Client Certificate
	 * @param {String} cert - certificate name
	 */
	learn.given([&quot;I use a $CERT client certificate&quot;, &quot;I use an $CERT client certificate&quot;], function (certName, done) {
		assert(this.certificates, &quot;No client certificates&quot;);
		var cert = this.certificates[certName];
		assert(cert, &quot;Missing a &#x27;&quot; + certName + &quot;&#x27; certificate&quot;);
		var cert_dir = this.paths.certificates || this.paths.files || this.files;
		assert(cert_dir, &quot;Missing cert directory: &quot; + cert_dir);
		assert(helps.files.exists(cert_dir), &quot;Cert directory not found: &quot; + cert_dir);
		http.certificate(this.request, cert, {}, cert_dir);
		this.request.requestCert = true;
		done &amp;&amp; done();
	});

	/**
	 * Set an HTTP Header to a value
	 *
	 *      I set $header header to $value
	 *
	 *      I set header $header = $value
	 *
	 * @example
	 *
	 *      I set header Accept to application/json
	 *
	 * @method Set HTTP Request Header
	 * @param {String} name - header name
	 * @param {String} value - header value
	 */
	learn.given([&quot;I set $header header to $value&quot;, &quot;I set header $header = $value&quot;], function (name, value, done) {
		// debug(&quot;HTTP header %s =&gt; %s&quot;, name, value);
		this.request.headers[name] = value;
		done &amp;&amp; done();
	})

	/**
	 * Set an HTTP Header from a variable
	 *
	 *      I set $header header from $varname
	 *
	 * @example
	 *
	 *      I set test = 123
	 *      I set header x-my-header from test
	 *
	 * @method Set HTTP Request Header
	 * @param {String} name - header name
	 * @param {String} varname - a scoped variable name
	 */
	learn.given([&quot;I set $header header from $varname&quot;, &quot;I set header $header from $varname&quot;], function (name, varname, done) {
		var value = helps.vars.find(this, varname);
		// debug(&quot;HTTP header %s =&gt; (%s) %s&quot;, name, varname, value);
		this.request.headers[name] = value;
		done &amp;&amp; done();
	})

	/**
	 * Add an HTTP Query Parameter to the Request
	 *
	 *      I set parameter $key to $value
	 *
	 *      I set $key parameter to $value
	 *
	 *      I set $key param to $value
	 *
	 *      I set param $key to $value
	 *
	 * @example
	 *
	 *      I set parameter api_key to ABCD1234
	 *
	 * @method Set HTTP Request Parameter
	 * @param {String} name - query parameter name
	 * @param {String} value - query parameter value
	 */

	learn.given([&quot;I set parameter $key to $value&quot;, &quot;I set $key parameter to $value&quot;, &quot;I set $key param to $value&quot;, &quot;I set param $key to $value&quot;], function (key, value, done) {
		this.request.qs[key] = value;
		done &amp;&amp; done();
	});

	learn.given([&quot;I set parameter $key from $varname&quot;, &quot;I set $key parameter from $varname&quot;, &quot;I set $key param from $varname&quot;, &quot;I set param $key from $varname&quot;], function (key, varname, done) {
		this.request.qs[key] = helps.vars.get(this, varname);
		done &amp;&amp; done();
	});

	learn.given(/^I set headers to$/, function (headers, done) {
		done &amp;&amp; done();
	});

	learn.given([&quot;I use basic authentication&quot;, &quot;I login&quot;, &quot;I authenticate&quot;], function (done) {
		assert(this.agent, &quot;Missing user agent - refer to config JSON&quot;);

		http.authorize(this.request, this.agent);
		debug(&quot;authorised: %j &quot;, this.agent);
		done &amp;&amp; done();
	});

	learn.given([&quot;I use basic authentication as $agent&quot;, &quot;I login as $agent&quot;], function (agent, done) {
		assert(this.agents, &quot;Missing user agents - refer to config JSON&quot;);
		var credentials = this.agents[agent];
		assert(credentials, &quot;Missing user agent: &quot; + agent);

		http.authorize(this.request, credentials);
		debug(&quot;authorised: %j &quot;, credentials);
		done &amp;&amp; done();
	});

	/**
	 * Use OAUTH flow to authenticate using default agent
	 *
	 *      I use OAuth2
	 *
	 *      I use oauth
	 *
	 * @example
	 *
	 *      I use oauth
	 *
	 * @method Use Client Credentials to authenticate as default agent
	 *
	 */

	learn.given([&quot;I use OAuth2&quot;, &quot;I use oauth&quot;, &quot;I use OAuth2 credentials&quot;, &quot;I use oauth credentials&quot;], function (done) {
		assert(this.agent, &quot;Missing default agent&quot;);
		if (this.agent.access_token) {
			http.bearer(this.request, this.agent.access_token);
			done &amp;&amp; done();
		} else {
			var self = this;
			http.client_credentials(this, this.agent, function (err, json) {
				if (err) {
					throw new Error(err);
				}
				vars.set(self.agent, &quot;access_token&quot;, json.access_token);
				http.bearer(self.request, self.agent.access_token);
				done &amp;&amp; done(err, json);
			});
		}
	});

	/**
	 * Use OAUTH flow to authenticate using a named agent
	 *
	 *      I use OAuth2 credentials as $agent
	 *
	 *      I use oauth credentials as $agent
	 *
	 *      I use client-credentials as $agent
	 *
	 * @example
	 *
	 *      I use client-credentials as default
	 *
	 * @method Use Client Credentials to authenticate
	 * @param {String} agent - named agent
	 */

	learn.given([&quot;I use OAuth2 credentials as $agent&quot;, &quot;I use oauth credentials as $agent&quot;, &quot;I use client-credentials as $agent&quot;], function (agent, done) {
		assert(this.agents, &quot;Missing agents&quot;);
		assert(agent, &quot;Missing agent&quot;);
		assert(this.agents[agent], &quot;Missing agent: &quot; + agent);

		http.client_credentials(this, this.agents[agent], function (err, json) {
			vars.set(self.agent, &quot;access_token&quot;, json);
			http.bearer(this.request, self.agent.access_token);
			done &amp;&amp; done(err, json);
		});
	});

	/**
	 * Set a named HTTP cookie to value
	 *
	 *     I set cookie $cookie to $value
	 *
	 *     I set cookie $cookie = $value
	 *
	 * @example
	 *
	 *     I set cookie my-tag = abc-1234
	 *
	 * @method Set named cookies
	 * @param {String} name - cookie name
	 * @param {String} value - cookie value
	 */

	learn.given([&quot;I set cookie $cookie to $value&quot;, &quot;I set cookie $cookie = $value&quot;], function (name, value, done) {
		this.request.jar = this.cookies;
		this.request.cookie(name + &quot;=&quot; + value);
		done &amp;&amp; done();
	});

	/**
	 * Set a named HTTP timeout to a time in milliseconds
	 *
	 *     I set request timeout to $time
	 *
	 * @example
	 *
	 *     GIVEN I set request timeout to 3000
	 *
	 * @method Set HTTP timeout
	 * @param {String} timeout - duration in milliseconds
	 */

	learn.given([&quot;I set request timeout to $time&quot;], function (timeInMillis, done) {
		this.request.timeout = timeInMillis ? timeInMillis : 10000;
		debug(&quot;HTTP timeout: %j &quot;, this.request.timeout);
		done &amp;&amp; done();
	});

	/**
	 * Enable HTTP keep-alive
	 *
	 *     I enable keep-alive
	 *
	 * @example
	 *
	 *     GIVEN I enable keep-alive
	 *
	 * @method Enable HTTP keep alive
	 */

	learn.given([&quot;I enable keep alive&quot;], function (done) {
		this.request.forever = true;
		done &amp;&amp; done();
	});

	/**
	 * Disable HTTP keep-alive
	 *
	 *     I disable keep-alive
	 *
	 * @example
	 *
	 *     GIVEN I disable keep-alive
	 *
	 * @method Disable HTTP keep alive
	 */


	learn.given([&quot;I disable keep alive&quot;], function (done) {
		this.request.forever = false;
		done &amp;&amp; done();
	})

	/**
	 * Enable HTTP GZIP compression
	 *
	 *     I enable gzip
	 *
	 * @example
	 *
	 *     GIVEN I enable gzip
	 *
	 * @method Enable HTTP GZIP compression
	 */

	learn.given([&quot;I enable gzip&quot;], function (done) {
		this.request.gzip = true;
		done &amp;&amp; done();
	})

	/**
	 * Disable HTTP GZIP compression
	 *
	 *     I disable gzip
	 *
	 * @example
	 *
	 *     GIVEN I disable gzip
	 *
	 * @method Disable HTTP GZIP compression
	 */

	learn.given([&quot;I disable gzip&quot;], function (done) {
		this.request.gzip = false;
		done &amp;&amp; done();
	})

	learn.given([&quot;I set encoding to $encoding&quot;], function (encoding, done) {
		this.request.encoding = encoding ? encoding : &quot;utf8&quot;;
		done &amp;&amp; done();
	})

	learn.given([&quot;I enable redirects&quot;], function (done) {
		this.request.followRedirect = true;
		done &amp;&amp; done();
	})

	learn.given([&quot;I disable redirects&quot;], function (done) {
		this.request.followRedirect = false;
		done &amp;&amp; done();
	})

	learn.given([&quot;I enable strict SSL&quot;], function (done) {
		this.request.strictSSL = true;
		done &amp;&amp; done();
	})

	learn.given([&quot;I disable strict SSL&quot;], function (done) {
		this.request.strictSSL = false;
		done &amp;&amp; done();
	})

	learn.given([&quot;I enable client certificates&quot;], function (done) {
		this.request.requestCert = true;
		done &amp;&amp; done();
	})

	learn.given([&quot;I disable client certificates&quot;], function (done) {
		this.request.requestCert = false;
		done &amp;&amp; done();
	})

	learn.given([&quot;I request JSON&quot;], function (done) {
		//        this.request.json = true;
		this.request.headers[&#x27;Content-Type&#x27;] = this.request.headers[&#x27;Content-Type&#x27;] || &quot;application/json&quot;;
		done &amp;&amp; done();
	})

	learn.when([&quot;I upload $file&quot;], function (file, done) {
		http.header(this.request, &quot;Content-Type&quot;, helps.webapi.EXT_TO_MIME.xml);
		webapi.uploadFormFile(this, &quot;files&quot;, file, done);
	});

	learn.when([&quot;I upload $path $file&quot;], function (path, file, done) {
		webapi.uploadFormFile(this, path, file, done);
	});

	learn.when([&quot;I upload $path from $file&quot;], function (path, file, done) {
		webapi.uploadFormFile(this, path, file, done);
	});

	learn.given([&quot;I send $path $file as body&quot;, &quot;I upload $path $file as body&quot;, &quot;I send $path $file as attachment&quot;, &quot;I upload $path $file as attachment&quot;], function (file, done) {
		webapi.attachFile(this, path, file, done);
	});

	learn.given([&quot;I send $file as body&quot;, &quot;I upload $file as body&quot;, &quot;I send $file as attachment&quot;, &quot;I upload $file as attachment&quot;], function (file, done) {
		webapi.attachFile(this, &quot;files&quot;, file, done);
	});

	/**
	 * Set HTTP response to payload. Objects are sent as JSON, everything else as BODY text.
	 *
	 *     I set body to $payload
	 *
	 * @example
	 *
	 *     I set body to hello world
	 *
	 * @method Set HTTP response
	 * @param {String} payload - JSON or text payload
	 */

	learn.given([&quot;I set body to $payload&quot;], function (value, done) {
		assert(value != undefined, &quot;Payload is undefined&quot;);

		if (_.isString(value)) {
			this.request.body = value;
			debug(&quot;set HTTP body: %j &quot;, value);
		} else {
			this.request.json = value;
			debug(&quot;set HTTP json body: %j &quot;, value);
		}
		done &amp;&amp; done();
	});

	learn.given([&quot;I set body from $varname&quot;], function (name, done) {
		var value = helps.vars.find(this, name);
		assert(value != undefined, &quot;Variable &quot; + name + &quot; is undefined&quot;);

		if (_.isString(value)) {
			this.request.body = value;
			debug(&quot;set HTTP body: %j &quot;, value);
		} else {
			this.request.json = value;
			debug(&quot;set HTTP json body: %j &quot;, value);
		}
		done &amp;&amp; done();
	});

	learn.given([&quot;I set text body from $varname&quot;], function (name, done) {
		var value = helps.vars.find(this, name);
		assert(value != undefined, &quot;Variable &quot; + name + &quot; is undefined&quot;);
		this.request.body = JSON.stringify(value);
		debug(&quot;set HTTP text body: %j &quot;, value);
		done &amp;&amp; done();
	});

	/**
	 * Set HTTP response to CSV payload.
	 *
	 *     I set body to CSV:
	 *     ------------
	 *     $CSV
	 *     ------------
	 *
	 *     I send CSV:
	 *     ------------
	 *     $CSV
	 *     ------------
	 *
	 * @example
	 *
	 *     I set body to CSV:
	 *     ------------
	 *     what, who
	 *     hello, world
	 *     ------------
	 *
	 * @method Set HTTP response
	 * @param {String} payload - JSON or text payload
	 */

	learn.given([&quot;I set body to CSV:\n$CSV&quot;, &quot;I send CSV:\n$CSV&quot;], function (value, done) {
		this.request.json = value;
		done &amp;&amp; done();
	});

	/**
	 * Set HTTP response to JSON payload.
	 *
	 *     I set body to JSON:
	 *     ------------
	 *     $JSON
	 *     ------------
	 *
	 *     I send JSON:
	 *     ------------
	 *     $JSON
	 *     ------------
	 *
	 * @example
	 *
	 *     I set body to JSON:
	 *     ------------
	 *     { &quot;what&quot;: &quot;hello&quot;, &quot;who&quot;: &quot;world&quot; }
	 *     ------------
	 *
	 * @method Set HTTP response
	 * @param {String} payload - JSON or text payload
	 */

	learn.given([&quot;I set body to JSON:\n$JSON&quot;, &quot;I send JSON:\n$JSON&quot;], function (value, done) {
		assert(this.request, &quot;Missing HTTP request&quot;);
		this.request.json = value;
		done &amp;&amp; done();
	});

	/**
	 * Set HTTP response to JSON payload.
	 *
	 *     I set body to JSON:
	 *     ------------
	 *     $JSON
	 *     ------------
	 *
	 *     I send JSON:
	 *     ------------
	 *     $JSON
	 *     ------------
	 *
	 * @example
	 *
	 *     I set body to JSON:
	 *     ------------
	 *     { &quot;what&quot;: &quot;hello&quot;, &quot;who&quot;: &quot;world&quot; }
	 *     ------------
	 *
	 * @method Set HTTP response
	 * @param {String} payload - JSON or text payload
	 */

	learn.given([&quot;I set body to XML:\n$XML&quot;, &quot;I send XML:\n$XML&quot;], function (value, done) {
		assert(this.request, &quot;Missing HTTP request&quot;);
		debug(&quot;Body XML: %s&quot;, value);

		http.header(this.request, &quot;Content-Type&quot;, helps.webapi.EXT_TO_MIME.xml);
		this.request.body = value;
		done &amp;&amp; done();
	});

	/**
	 * Set HTTP response to raw (text) payload.
	 *
	 *     I set body to:
	 *     ------------
	 *     $TEXT
	 *     ------------
	 *
	 *     I send:
	 *     ------------
	 *     $TEXT
	 *     ------------
	 *
	 * @example
	 *
	 *     I set body to:
	 *     ------------
	 *     Hello World
	 *     ------------
	 *
	 * @method Set HTTP response
	 * @param {String} text payload
	 */

	learn.given([&quot;I set body to:\n$TEXT&quot;, &quot;I send:\n$TEXT&quot;], function (value, done) {
		this.request.body = value;
		done &amp;&amp; done();
	});

	/**
	 * Issue an HTTP GET request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I GET $resource
	 *
	 * @example
	 *
	 *     I GET /
	 *     I GET http://example.com
	 *
	 * @method Send HTTP GET request
	 * @param {String} resource - target resource path or full URL
	 */

	learn.when(&quot;I GET $resource&quot;, function (resource, done) {
		assert(resource, &quot;Missing GET resource&quot;);
		assert(done, &quot;Missing callback&quot;);
		assert(this.request, &quot;Missing request&quot;);
		var cmd = http.command(&quot;GET&quot;, resource, this.request, this.target);
		request(cmd, http.handleResponse(this, done));
	});

	learn.when(&quot;I GET JSON from $resource&quot;, function (resource, done) {
		assert(resource, &quot;Missing GET resource&quot;);
		assert(done, &quot;Missing callback&quot;);
		assert(this.request, &quot;Missing request&quot;);
		var cmd = http.command(&quot;GET&quot;, resource, this.request, this.target);
		cmd.json = true;
		request(cmd, http.handleResponse(this, done));
	});

	/**
	 * Issue an HTTP POST request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I POST $resource
	 *
	 * @example
	 *
	 *     I POST /
	 *     I POST http://example.com
	 *
	 * @method Send HTTP POST request
	 * @param {String} resource - target resource path or full URL
	 */

	learn.when(&quot;I POST $resource&quot;, function (resource, done) {
		var cmd = http.command(&quot;POST&quot;, resource, this.request, this.target);
		var r = request(cmd, http.handleResponse(this, done));
	});

	/**
	 * Issue an HTTP PUT request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I PUT $resource
	 *
	 * @example
	 *
	 *     I PUT /
	 *     I PUT http://example.com
	 *
	 * @method Send HTTP PUT request
	 * @param {String} resource - target resource path or full URL
	 */

	learn.when(&quot;I PUT $resource&quot;, function (resource, done) {
		var cmd = http.command(&quot;PUT&quot;, resource, this.request, this.target);
		request(cmd, http.handleResponse(this, done));
	});

	/**
	 * Issue an HTTP DELETE request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I DELETE $resource
	 *
	 * @example
	 *
	 *     I DELETE /
	 *     I DELETE http://example.com
	 *
	 * @method Send HTTP DELETE request
	 * @param {String} resource - target resource path or full URL
	 */

	learn.when(&quot;I DELETE $resource&quot;, function (resource, done) {
		var cmd = http.command(&quot;DELETE&quot;, resource, this.request, this.target);
		request(cmd, http.handleResponse(this, done));
	});

	//learn.when(&quot;I $verb $resource&quot;, function(verb, resource, done) {
	//    var cmd = http.command(verb.toUpperCase(), resource, this.request, this.target );
	//    request(cmd, http.handleResponse(this, done));
	//});

	/**
	 * Issue an HTTP PATCH request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I PATCH $resource
	 *
	 * @example
	 *
	 *     I PATCH /
	 *     I PATCH http://example.com
	 *
	 * @method Send HTTP PATCH request
	 * @param {String} resource - target resource path or full URL
	 */
	learn.when(&quot;I PATCH $resource&quot;, function (resource, done) {
		var cmd = http.command(&quot;PATCH&quot;, resource, this.request, this.target);
		request(cmd, http.handleResponse(this, done));
	});

	/**
	 * Issue an HTTP HEAD request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I request HEAD for $resource
	 *
	 * @example
	 *
	 *     I request HEAD for /
	 *     I request HEAD for http://example.com
	 *
	 * @method Send HTTP HEAD request
	 * @param {String} resource - target resource path or full URL
	 */

	learn.when(&quot;I request HEAD for $resource&quot;, function (resource, done) {
		var cmd = http.command(&quot;HEAD&quot;, resource, this.request, this.target);
		request(cmd, http.handleResponse(this, done));
	});

	/**
	 * Issue an HTTP POST request to default target or an absolute URL.
	 * The @target annotation is used to select a target
	 *
	 *     I request OPTIONS for $resource
	 *
	 * @example
	 *
	 *     I request OPTIONS for /
	 *     I request OPTIONS for  http://example.com
	 *
	 * @method Send request for HTTP OPTIONS
	 * @param {String} resource - target resource path or full URL
	 */

	learn.when(&quot;I request OPTIONS for $resource&quot;, function (resource, done) {
		var cmd = http.command(&quot;OPTIONS&quot;, resource, this.request, this.target);
		request(cmd, http.handleResponse(this, done));
	});

	/**
	 * Set an OAUTH access_token both as scoped variable for use in subsequent requests.
	 * The $path parameter is a JSON path used to access the (non-standard) access_token from the current HTTP response.
	 *
	 *     I store body path $path as access token
	 *
	 * @example
	 *
	 *     I store body path $.access_token as access token
	 *
	 * @method Set access_token
	 * @param {String} token - valid oauth access token
	 */

	learn.when(&quot;I store body path $path as access token&quot;, function (path, done) {
		var access_token = http.findInPath(this.response.body, path);
		assert(access_token, &quot;Body path &quot; + path + &quot; does not contains an access_token&quot;);
		this.vars.access_token = access_token;
		done &amp;&amp; done();
	});

	/**
	 * Extra a value from the (JSON) body and store as a scoped variable
	 *
	 *     I store body path $path as $name
	 *
	 * @example
	 *
	 *     I store body path $.access_token as access-token
	 *
	 * @method Extract variable from a JSON response
	 * @param {String} path - JSON Path to extract variable
	 * @param {String} name - scoped variable to store result
	 */

	learn.when(&quot;I store body path $path as $name&quot;, function (path, name, done) {
		var value = http.findInPath(this.response.body, path);
		assert(value, &quot;Value for &quot; + path + &quot; is empty&quot;);
		vars.set(this.vars, name, value);
		done &amp;&amp; done();
	});

	/**
	 * Extract avalue from HTTP header and store as a scoped variable
	 *
	 *     I store header $header as $name
	 *
	 * @example
	 *
	 *     I store header ApiKey as client_id
	 *
	 * @method Extract variable from an HTTP header
	 * @param {String} header - name of header to extract
	 * @param {String} name - scoped variable to store result
	 */

	learn.when(&quot;I store header $header as $name&quot;, function (header, name, done) {
		header = header.toLowerCase();
		this.vars[name] = this.response.headers[header];
		done &amp;&amp; done();
	});

	/**
	 * Generate a TOTP token based on the shared secret and current time.
	 *
	 * @example
	 *
	 *     I use totp
	 *
	 */

	learn.when(&quot;I use totp&quot;, function (done) {
		assert(this.agent, &quot;Missing agent&quot;);

		var agent = this.agent;
		assert(agent.totp, &quot;Missing agent.totp&quot;);
		assert(agent.totp.secret, &quot;Missing agent.totp.secret&quot;);

		agent.totp.token = speakeasy.totp({
			secret: agent.totp.secret,
			encoding: agent.totp.encoding || &#x27;base32&#x27;,
			window: agent.totp.window || 2,
			step: agent.totp.step || 60
		});

		done &amp;&amp; done();
	});

	learn.when(&quot;I use totp as $agent&quot;, function (actor, done) {
		assert(this.agents, &quot;Missing agents&quot;);
		assert(this.agents[actor], &quot;Missing agent &quot; + actor);

		var agent = this.agents[actor];
		assert(agent.totp, &quot;Missing config for agent.totp&quot;);
		assert(agent.totp.secret, &quot;Missing agent.totp.secret&quot;);

		agent.totp.token = speakeasy.totp({
			secret: agent.totp.secret,
			encoding: agent.totp.encoding || &#x27;base32&#x27;,
			window: agent.totp.window || 2,
			step: agent.totp.step || 60
		});

		done &amp;&amp; done();
	});


	// ******** THEN ********

	learn.then(&quot;response code should be $code&quot;, function (code, done) {
		assert(this.response, &quot;No HTTP response&quot;);
		var codes = code.split(&quot;,&quot;);
		var passed = false;
		var self = this;
		_.each(codes, function (code) {
			passed = passed || http.IsStatusCodeXX(code.trim(), self.response.statusCode);
		});
		assert(passed, &quot;Status code is &quot; + this.response.statusCode + &quot; not &quot; + code);
		done &amp;&amp; done();
	});

	learn.then(&quot;response code should not be $code&quot;, function (code, done) {
		assert(this.response, &quot;No HTTP response&quot;);
		var codes = code.split(&quot;,&quot;);
		var failed = false;
		var self = this;
		_.each(codes, function (code) {
			failed = failed || !http.IsStatusCodeXX(code.trim(), self.response.statusCode);
		});
		assert(failed, &quot;Status code is &quot; + this.response.statusCode);
		done &amp;&amp; done();
	});


	learn.then([&quot;elapsed time should be less than $elapsed&quot;, &quot;duration should be less than $elapsed&quot;], function (elapsed, done) {
		assert(this.stopwatch.duration &lt; elapsed);
		done &amp;&amp; done();
	});

	learn.then(&quot;header $header should be $value&quot;, function (header, value, done) {
		header = header.toLowerCase();
		assert(this.response.headers[header] == value, &quot;Header &quot; + header + &quot; should match &quot; + value + &quot; but not &quot; + this.response.headers[header]);
		done &amp;&amp; done();
	});

	learn.then(&quot;header $header should contain $value&quot;, function (header, value, done) {
		header = header.toLowerCase();
		assert(this.response.headers[header].indexOf(value) &gt;= 0, &quot;Header &quot; + header + &quot; should contain &quot; + value + &quot; but does not: &quot; + this.response.headers[header]);
		done &amp;&amp; done();
	});

	learn.then(&quot;header $header should not be $value&quot;, function (header, value, done) {
		header = header.toLowerCase();
		assert(this.response.headers[header] != value, &quot;Header &quot; + header + &quot; should not match &quot; + value);
		done &amp;&amp; done();
	});

	learn.then(&quot;header $header should exist&quot;, function (header, done) {
		header = header.toLowerCase();
		assert(this.response.headers[header], &quot;Missing &quot; + header + &quot; header&quot;);
		done &amp;&amp; done();
	});

	learn.then(&quot;header $header should not exist&quot;, function (header, done) {
		header = header.toLowerCase();
		assert(this.response.headers[header] == undefined, &quot;Found &quot; + header + &quot; header&quot;);
		done &amp;&amp; done();
	});

	learn.then(/^response body should be valid (xml|json)$/, function (contentType, done) {
		var simpleType = http.detectContentType(this.response.body);
		assert(simpleType == contentType, &quot;Payload is not valid &quot; + contentType.toUpperCase());
		done &amp;&amp; done();
	});

	learn.then(&quot;/^response body should not be valid (xml|json)$/&quot;, function (contentType, done) {
		var simpleType = http.detectContentType(this.response.body);
		assert(simpleType != contentType, &quot;Payload is valid &quot; + contentType.toUpperCase());
		done &amp;&amp; done();
	});

	learn.then(&quot;response body should contain $expression&quot;, function (expression, done) {
		var found = new RegExp(expression).test(this.response.body);
		assert(found, &quot;Body does not contain /&quot; + expression + &quot;/&quot;);
		done &amp;&amp; done();
	});

	learn.then(&quot;response body should not contain $expression&quot;, function (expression, done) {
		var found = new RegExp(expression).test(this.response.body);
		assert(!found, &quot;Body contains /&quot; + expression + &quot;/&quot;);
		done &amp;&amp; done();
	});

	learn.then(/^response body path (.*) should exist/, function (path, done) {
		var found = http.findInPath(this.response.body, path);
		assert(found, &quot;Body path &quot; + path + &quot; not found&quot;);
		done &amp;&amp; done();
	});

	learn.then(/^response body path (.*) should not exist/, function (path, done) {
		var found = http.findInPath(this.response.body, path);
		assert(!found, &quot;Body path &quot; + path + &quot; was found&quot;);
		done &amp;&amp; done();
	});

	learn.then([/^response body path (.*) should be ((?!of type).+)$/, /^response body path (.*) should contain ((?!of type).+)$/], function (path, expression, done) {
		var found = http.findInPath(this.response.body, path);
		var matched = new RegExp(expression).test(found);
		assert(matched, &quot;Body path &quot; + path + &quot; does not contain /&quot; + expression + &quot;/&quot;);
		done &amp;&amp; done();
	});

	learn.then([/^response body path (.*) should not be ((?!of type).+)$/, /^response body path (.*) should not contain ((?!of type).+)$/], function (path, expression, done) {
		var found = http.findInPath(this.response.body, path);
		var matched = new RegExp(expression).test(found);
		assert(!matched, &quot;Body path &quot; + path + &quot; contains /&quot; + expression + &quot;/&quot;);
		done &amp;&amp; done();
	});

	learn.then(&quot;cookie $cookie should exist&quot;, function (cookieJar, done) {
		this.request.jar = http.cookies();
		done &amp;&amp; done();
	})


	WebAPI.feature = function (dialect, scope) {
		assert(dialect, &quot;missing dialect&quot;);
		assert(scope, &quot;missing scope&quot;);
	};

	WebAPI.scenario = function (dialect, scope) {
		assert(dialect, &quot;missing dialect&quot;);
		assert(scope, &quot;missing scope&quot;);

		_.defaults(scope, {
			peer: {
				authorized: false
			},
            request: {
			    headers: {}
            }
		});
	};

	WebAPI.annotations = function (dialect, annotations, scope) {
		assert(dialect, &quot;missing dialect&quot;);
		assert(annotations, &quot;missing annotations&quot;);
		assert(scope, &quot;missing scope&quot;);
	}

	debug(&quot;understands HTTP/HTTPS&quot;);

};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
